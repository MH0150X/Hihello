<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡¶á‡¶â‡¶®‡ßÅ‡¶∏‡¶ï‡ßá ‡¶¨‡¶æ‡¶Å‡¶ö‡¶æ‡¶ì</title>
    <style>
        /* CSS ‡¶ï‡ßã‡¶° ‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§ ‡¶Ü‡¶õ‡ßá */
        :root {
            --primary-color: #3498db;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            font-family: 'Arial', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { width: 100%; height: 100%; overflow: hidden; background-color: var(--dark-color); color: var(--light-color); }
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #1a1a1a; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; transition: opacity 0.5s; }
        #loading-screen .loader { border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1.5s linear infinite; }
        #loading-screen p { margin-top: 20px; font-size: 1.2em; }
        @keyframes spin { 0% { transform: rotate(0deg); } 50% { transform: rotate(180deg); } 100% { transform: rotate(360deg); } }
        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 99; background-size: cover; background-position: center; transition: opacity 0.5s; }
        @media (min-width: 768px) { #start-screen { background-image: url('https://placehold.co/1920x1080/2c3e50/ecf0f1?text=‡¶°‡ßá‡¶∏‡ßç‡¶ï‡¶ü‡¶™+‡¶•‡¶ø‡¶Æ'); } }
        @media (max-width: 767px) { #start-screen { background-image: url('https://placehold.co/720x1280/16a085/ecf0f1?text=‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤+‡¶•‡¶ø‡¶Æ'); } }
        #start-button { padding: 20px 40px; font-size: 2.2em; background: linear-gradient(145deg, #e74c3c, #c0392b); color: white; border: none; border-radius: 15px; cursor: pointer; text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5); box-shadow: 0 8px 15px rgba(0,0,0,0.3), inset 0 -4px 0 #a52d22; transition: transform 0.2s, box-shadow 0.2s; animation: pulse 2s infinite; }
        #start-button:hover { transform: scale(1.05) translateY(-2px); box-shadow: 0 12px 20px rgba(0,0,0,0.4), inset 0 -4px 0 #a52d22; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
        #game-container { position: relative; width: 100%; height: 100%; display: none; }
        canvas { display: block; width: 100%; height: 100%; background: transparent; }
        .health-bar-container { position: absolute; top: 20px; width: clamp(200px, 25%, 350px); display: flex; align-items: center; gap: 12px; background-color: rgba(10, 20, 30, 0.65); padding: 8px; border-radius: 8px; border: 1px solid rgba(150, 160, 180, 0.4); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 10; }
        .health-bar-avatar { width: 40px; height: 40px; border-radius: 6px; border: 2px solid rgba(255, 255, 255, 0.7); object-fit: cover; }
        .health-bar-info { flex-grow: 1; }
        .health-bar-name { color: #f0f0f0; font-weight: bold; text-shadow: 1px 1px 2px black; font-size: 1em; margin-bottom: 6px; }
        .health-bar { height: 12px; background-color: #4a1d1d; border-radius: 4px; padding: 0; border: none; overflow: hidden; }
        .health-bar-inner { height: 100%; background: linear-gradient(90deg, #2ecc71, #58d68d); border-radius: 4px; width: 100%; transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1); }
        #hero-health { left: 20px; }
        #villain-health { right: 20px; flex-direction: row-reverse; }
        @media (max-width: 767px) { .health-bar-container { width: clamp(120px, 40%, 180px); gap: 8px; padding: 6px; top: 10px; } #hero-health { left: 10px; } #villain-health { right: 10px; } .health-bar-avatar { width: 30px; height: 30px; } .health-bar-name { font-size: 0.8em; } .health-bar { height: 10px; } }
        #controls-container { position: fixed; bottom: 20px; left: 20px; right: 20px; height: auto; display: flex; justify-content: space-between; align-items: flex-end; z-index: 50; pointer-events: none; }
        .control-pad { pointer-events: all; }
        #left-controls { display: flex; gap: 20px; }
        #right-controls { display: grid; grid-template-areas: ". jump ." "attack shield special"; gap: 15px; }
        .control-button { width: 60px; height: 60px; background: rgba(255, 255, 255, 0.25); border: 2px solid rgba(255, 255, 255, 0.5); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.8em; color: white; user-select: none; cursor: pointer; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); box-shadow: 0 4px 8px rgba(0,0,0,0.3); transition: all 0.1s ease-out; }
        @media (max-width: 480px) { .control-button { width: 48px; height: 48px; font-size: 1.3em; } #controls-container { left: 10px; right: 10px; bottom: 15px; flex-direction: row; justify-content: space-between; gap: 10px; } #right-controls { display: grid; grid-template-areas: ". shield ." "attack . special" ". jump ."; grid-template-columns: 48px 48px 48px; grid-template-rows: 48px 48px 48px; gap: 10px; justify-content: center; align-content: center; align-items: center; } #jump-btn { grid-area: jump; } #attack-btn { grid-area: attack; } #special-btn { grid-area: special; } #shield-btn { grid-area: shield; } #left-controls { gap: 10px; justify-content: center; } }
        .control-button:active { transform: translateY(2px) scale(0.95); box-shadow: 0 2px 4px rgba(0,0,0,0.3); background: rgba(255, 255, 255, 0.4); }
        #jump-btn { grid-area: jump; } #attack-btn { grid-area: attack; } #special-btn { grid-area: special; } #shield-btn { grid-area: shield; }
        .cooldown { background: rgba(50, 50, 50, 0.7) !important; color: rgba(255, 255, 255, 0.5) !important; pointer-events: none !important; position: relative; overflow: hidden; box-shadow: none; }
        .cooldown::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .cooldown::after { content: attr(data-cooldown); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.8em; font-weight: bold; color: white; }
        #game-over-message { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: clamp(3em, 10vw, 6em); font-weight: bold; z-index: 100; display: none; text-align: center; animation: gameOverAnim 1s ease-out forwards; }
        .win-message { color: #2ecc71; text-shadow: 0 0 10px #2ecc71, 0 0 20px #fff, 0 0 30px #fff; }
        .lose-message { color: #e74c3c; text-shadow: 0 0 10px #e74c3c, 0 0 20px #000, 0 0 30px #000; }
        @keyframes gameOverAnim { from { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loader"></div>
        <p>‡¶ó‡ßá‡¶Æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
    </div>

    <div id="start-screen" style="display: none;">
        <button id="start-button">‡¶ó‡ßá‡¶Æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <div id="game-container">
        <div id="hero-health" class="health-bar-container">
            <img id="hero-avatar" src="" class="health-bar-avatar">
            <div class="health-bar-info">
                <div id="hero-name" class="health-bar-name">‡¶π‡¶ø‡¶∞‡ßã</div>
                <div class="health-bar"><div id="hero-health-inner" class="health-bar-inner"></div></div>
            </div>
        </div>
        <div id="villain-health" class="health-bar-container">
            <img id="villain-avatar" src="" class="health-bar-avatar">
            <div class="health-bar-info">
                <div id="villain-name" class="health-bar-name">‡¶≠‡¶ø‡¶≤‡ßá‡¶®</div>
                <div class="health-bar"><div id="villain-health-inner" class="health-bar-inner"></div></div>
            </div>
        </div>

        <canvas id="gameCanvas"></canvas>

        <div id="game-over-message"></div>

        <div id="controls-container">
            <div id="left-controls" class="control-pad">
                <button id="left-btn" class="control-button">‚Üê</button>
                <button id="right-btn" class="control-button">‚Üí</button>
            </div>
            <div id="right-controls" class="control-pad">
                <button id="jump-btn" class="control-button">‚Üë</button>
                <button id="attack-btn" class="control-button">‚öîÔ∏è</button>
                <button id="shield-btn" class="control-button">‚òÇÔ∏è</button>
                <button id="special-btn" class="control-button">üî•</button>
            </div>
        </div>
    </div>
    
    <audio id="bg-music" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" preload="auto"></audio>
    <audio id="attack-sound" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" preload="auto"></audio>
    <audio id="jump-sound" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" preload="auto"></audio>
    <audio id="powerup-sound" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3" preload="auto"></audio>
    <audio id="shield-sound" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3" preload="auto"></audio>
    <audio id="game-over-sound" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-10.mp3" preload="auto"></audio>
    <audio id="urine-attack-sound" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3" preload="auto"></audio>
    <audio id="blow-attack-sound" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3" preload="auto"></audio>
    <audio id="chada-attack-sound" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" preload="auto"></audio>
    <audio id="election-attack-sound" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-9.mp3" preload="auto"></audio>
    <audio id="bird-dialogue-sound" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-11.mp3" preload="auto"></audio>
    <audio id="hero-dialogue-jump" src="path/to/your/jump_sound.mp3" preload="auto"></audio>
    <audio id="hero-dialogue-attack" src="path/to/your/attack_sound.mp3" preload="auto"></audio>


<script>
// ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶ü‡¶ø-‡¶á‡¶®‡ßç‡¶∏‡¶™‡ßá‡¶ï‡ßç‡¶ü
document.addEventListener('contextmenu', event => event.preventDefault());
document.onkeydown = function(e) {
    if (e.keyCode == 123 || (e.ctrlKey && e.shiftKey && (e.keyCode == 'I'.charCodeAt(0) || e.keyCode == 'J'.charCodeAt(0) || e.keyCode == 'C'.charCodeAt(0))) || (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0))) {
        return false;
    }
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let gameRunning = false;
let gameOver = false;
let parallaxOffset = 0;
let dayNightCycle = 0;

// ‡¶¶‡¶ø‡¶®-‡¶∞‡¶æ‡¶§ ‡¶ö‡¶ï‡ßç‡¶∞‡ßá‡¶∞ ‡¶ó‡¶§‡¶ø ‡¶¨‡¶æ‡¶°‡¶º‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
const timeTransitionSpeed = 0.0015;

// ‡¶∞‡¶ø‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü URL
const redirectUrl = "https://www.example.com"; // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶õ‡¶®‡ßç‡¶¶‡ßá‡¶∞ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡¶ø‡¶®

function triggerVibration(pattern = 25) {
    if (window.navigator && window.navigator.vibrate) {
        try { navigator.vibrate(pattern); } catch (e) { console.log("Vibration failed", e); }
    }
}

const ASSETS = {
    hero: { idle: 'https://placehold.co/150x180/3498db/ffffff?text=Hero+Idle', run: 'https://placehold.co/150x180/2980b9/ffffff?text=Hero+Run', jump: 'https://placehold.co/150x180/1f618d/ffffff?text=Hero+Jump', attack: 'https://placehold.co/200x180/5dade2/ffffff?text=Hero+Attack', special: 'https://placehold.co/250x180/85c1e9/ffffff?text=Hero+Special', shield: 'https://placehold.co/180x200/5499c7/ffffff?text=Hero+Shield', hurt: 'https://placehold.co/150x180/a9cce3/ffffff?text=Hero+Hurt', out: 'https://placehold.co/180x150/d4e6f1/ffffff?text=Hero+Out' },
    villain: { idle: 'https://placehold.co/160x190/e74c3c/ffffff?text=Villain+Idle', run: 'https://placehold.co/160x190/c0392b/ffffff?text=Villain+Run', jump: 'https://placehold.co/160x190/a93226/ffffff?text=Villain+Jump', hurt: 'https://placehold.co/160x190/f5b7b1/ffffff?text=Villain+Hurt', out: 'https://placehold.co/190x160/fADBD8/ffffff?text=Villain+Out', attacks: { urine: 'https://placehold.co/220x190/f1c40f/ffffff?text=Urine+Atk', blow: 'https://placehold.co/220x190/aed6f1/ffffff?text=Blow+Atk', chada: 'https://placehold.co/220x190/f5b041/ffffff?text=Chada+Atk', election: 'https://placehold.co/220x190/af7ac5/ffffff?text=Election+Atk' } },
    projectiles: { 
        // ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶á ‡¶™‡ßç‡¶≤‡ßá‡¶∏‡¶π‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶ú‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ URL ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶õ‡¶®‡ßç‡¶¶‡ßá‡¶∞ ‡¶õ‡¶¨‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®
        hero_special: 'https://placehold.co/80x50/ADD8E6/000000?text=Special', // ‡¶π‡¶ø‡¶∞‡ßã‡¶∞ ‡¶∏‡ßç‡¶™‡ßá‡¶∂‡¶æ‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ï‡ßá‡¶∞ ‡¶™‡ßç‡¶≤‡ßá‡¶∏‡¶π‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞
        villain_urine: 'https://placehold.co/60x40/FFFF00/000000?text=Urine', // ‡¶≠‡¶ø‡¶≤‡ßá‡¶®‡ßá‡¶∞ ‡¶á‡¶â‡¶∞‡¶ø‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ï‡ßá‡¶∞ ‡¶™‡ßç‡¶≤‡ßá‡¶∏‡¶π‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞
        villain_blow: 'https://placehold.co/60x40/FF00FF/FFFFFF?text=Blow', // ‡¶≠‡¶ø‡¶≤‡ßá‡¶®‡ßá‡¶∞ ‡¶¨‡ßç‡¶≤‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ï‡ßá‡¶∞ ‡¶™‡ßç‡¶≤‡ßá‡¶∏‡¶π‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞
        villain_chada: 'https://placehold.co/60x40/00FFFF/000000?text=Chada', // ‡¶≠‡¶ø‡¶≤‡ßá‡¶®‡ßá‡¶∞ ‡¶ö‡¶æ‡¶¶‡¶æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ï‡ßá‡¶∞ ‡¶™‡ßç‡¶≤‡ßá‡¶∏‡¶π‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞
        villain_election: 'https://placehold.co/60x40/FF4500/FFFFFF?text=Election' // ‡¶≠‡¶ø‡¶≤‡ßá‡¶®‡ßá‡¶∞ ‡¶á‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ï‡ßá‡¶∞ ‡¶™‡ßç‡¶≤‡ßá‡¶∏‡¶π‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞
    },
    powerups: { health: 'https://i.imgur.com/Guahcab.png' },
    environment: { bird: 'https://i.imgur.com/l6c32xi.gif', sky: 'https://i.imgur.com/2gMxkwF.jpeg', sun: 'https://i.imgur.com/flJCvnZ.png', moon: 'https://i.imgur.com/eKBeccg.png', cloud: 'https://i.imgur.com/idu05Ur.png', ground: 'https://i.imgur.com/ptglOIp.png', house: 'https://i.imgur.com/vQBrMiE.png' }
};

const images = {};

function loadAssets(callback) {
    const assetsToLoad = [];
    function collectAssetUrls(obj) { for (const key in obj) { if (typeof obj[key] === 'string') assetsToLoad.push(obj[key]); else if (typeof obj[key] === 'object') collectAssetUrls(obj[key]); } }
    collectAssetUrls(ASSETS);
    if (assetsToLoad.length === 0) { callback(); return; }
    let loadedCount = 0;
    assetsToLoad.forEach(src => { const img = new Image(); img.src = src; images[src] = img; img.onload = img.onerror = () => { if (++loadedCount === assetsToLoad.length) callback(); }; });
}

let hero, villain, powerups, projectiles, stars = [], clouds = [], bird;

class Character {
    constructor(x, y, width, height, health, speed, assets) { Object.assign(this, { x, y, width, height, maxHealth: health, health, speed, dx: 0, dy: 0, gravity: 0.8, jumpPower: -20, isJumping: true, isAttacking: false, isShielded: false, direction: 'right', isHurt: false, isOut: false, currentState: 'idle', assets }); }
    draw() {
        if (this.isOut) this.currentState = 'out';
        else if (this.isHurt) this.currentState = 'hurt';
        else if (this.isAttacking) {} 
        else if (this.isShielded) this.currentState = 'shield';
        else if (this.isJumping) this.currentState = 'jump';
        else if (this.dx !== 0) this.currentState = 'run';
        else this.currentState = 'idle';
        let assetSrc = this.assets[this.currentState] || (this.assets.attacks && this.assets.attacks[this.currentState]) || this.assets.idle;
        const img = images[assetSrc];
        ctx.save();
        if (this.direction === 'left') { ctx.scale(-1, 1); if (img) ctx.drawImage(img, -this.x - this.width, this.y, this.width, this.height); } 
        else { if (img) ctx.drawImage(img, this.x, this.y, this.width, this.height); }
        ctx.restore();
    }
    update() {
        if (this.isOut) { this.dx = 0; return; }
        this.x += this.dx; this.y += this.dy;
        if (this.y + this.height < canvas.height - groundHeight) { this.dy += this.gravity; this.isJumping = true; } 
        else { this.dy = 0; this.isJumping = false; this.y = canvas.height - groundHeight - this.height; }
        this.x = Math.max(0, Math.min(this.x, canvas.width - this.width));
        if (this.health <= 0) { this.health = 0; this.isOut = true; if(!gameOver) triggerGameOver(this === hero ? '‡¶≠‡¶ø‡¶≤‡ßá‡¶® ‡¶ú‡¶ø‡¶§‡ßá‡¶õ‡ßá!' : '‡¶π‡¶ø‡¶∞‡ßã ‡¶ú‡¶ø‡¶§‡ßá‡¶õ‡ßá!'); }
        this.draw();
    }
    takeDamage(amount) { 
        if (this.isShielded || this.isOut) return; 
        this.health -= amount; 
        // ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶∏‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶•‡ßç‡¶Ø ‡¶Ø‡ßá‡¶® ‡ß¶ ‡¶è‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá ‡¶®‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º
        if (this.health < 0) {
            this.health = 0;
        }
        this.isHurt = true; 
        triggerVibration([100, 30, 100]); 
        setTimeout(() => this.isHurt = false, 500); 
        updateHealthBars(); 
    }
    jump() { if (!this.isJumping && !this.isOut) { this.dy = this.jumpPower; this.isJumping = true; playSound('jump-sound'); } } 
}

class Villain extends Character {
    constructor(x, y, width, height, health, speed, assets) { 
        super(x, y, width, height, health, speed, assets); 
        this.attackCooldown = 0; 
        this.moveCooldown = 0; 
        this.attackRange = 400; // ‡¶Ü‡¶ï‡ßç‡¶∞‡¶Æ‡¶£‡ßá‡¶∞ ‡¶¶‡ßÇ‡¶∞‡¶§‡ßç‡¶¨
        this.jumpAttackChance = 0.6; // ‡¶≤‡¶æ‡¶´‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ï ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡¶®‡¶æ
    }

    ai() {
        if (this.isOut || this.isAttacking) return;

        // ‡¶≠‡¶ø‡¶≤‡ßá‡¶®‡ßá‡¶∞ ‡¶Æ‡ßÅ‡¶≠‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶ï‡ßç‡¶∞‡¶Æ‡¶£‡ßá‡¶∞ ‡¶∏‡¶ø‡¶¶‡ßç‡¶ß‡¶æ‡¶®‡ßç‡¶§
        const dxToHero = Math.abs(this.x - hero.x);
        const dyToHero = Math.abs(this.y - hero.y);
        const inAttackRange = dxToHero < this.attackRange && dyToHero < 150; // ‡¶Ü‡¶®‡ßÅ‡¶Æ‡¶æ‡¶®‡¶ø‡¶ï ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ

        // ‡¶≠‡¶ø‡¶≤‡ßá‡¶®‡ßá‡¶∞ ‡¶Æ‡ßÅ‡¶≠‡¶Æ‡ßá‡¶®‡ßç‡¶ü
        if (this.moveCooldown-- <= 0) {
            const action = Math.random();
            if (dxToHero > 100) { // ‡¶π‡¶ø‡¶∞‡ßã ‡¶•‡ßá‡¶ï‡ßá ‡¶¶‡ßÇ‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶è‡¶ó‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶∏‡¶¨‡ßá
                this.dx = (hero.x > this.x ? 1 : -1) * this.speed;
                this.direction = hero.x > this.x ? 'right' : 'left';
            } else if (dxToHero < 50) { // ‡¶π‡¶ø‡¶∞‡ßã‡¶∞ ‡¶ñ‡ßÅ‡¶¨ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡¶∞‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá
                this.dx = (hero.x > this.x ? -1 : 1) * this.speed / 2;
                this.direction = hero.x > this.x ? 'right' : 'left'; // ‡¶¶‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶¨‡ßá ‡¶®‡¶æ
            } else { // ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶¶‡ßÇ‡¶∞‡¶§‡ßç‡¶¨‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡ßç‡¶•‡¶ø‡¶∞ ‡¶¨‡¶æ ‡¶Ö‡¶≤‡ßç‡¶™ ‡¶®‡¶°‡¶º‡¶æ‡¶ö‡¶°‡¶º‡¶æ
                this.dx = 0;
            }

            // ‡¶π‡¶ø‡¶∞‡ßã ‡¶Ø‡¶¶‡¶ø ‡¶≤‡¶æ‡¶´‡¶ø‡¶Ø‡¶º‡ßá ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶≠‡¶ø‡¶≤‡ßá‡¶®‡¶ì ‡¶≤‡¶æ‡¶´‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ï ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶¨‡ßá
            if (hero.isJumping && !this.isJumping && inAttackRange && Math.random() < this.jumpAttackChance) {
                this.jump();
                // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ï ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶ú‡¶ø‡¶∞‡ßã ‡¶°‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶ú ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ï ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá, ‡¶§‡¶æ‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ï ‡¶ü‡ßç‡¶∞‡¶ø‡¶ó‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
                if (!this.isAttacking) {
                    const attacks = Object.keys(this.assets.attacks); 
                    const attackType = attacks[Math.floor(Math.random() * attacks.length)]; 
                    this.performAttack(attackType); 
                    this.attackCooldown = Math.random() * 60 + 30; // ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ï
                }
            } else if (action < 0.2 && !this.isJumping) { // ‡¶Æ‡¶æ‡¶ù‡ßá ‡¶Æ‡¶æ‡¶ù‡ßá ‡¶è‡¶Æ‡¶®‡¶ø‡¶§‡ßá‡¶á ‡¶≤‡¶æ‡¶´‡¶æ‡¶¨‡ßá
                this.jump();
            }

            this.moveCooldown = Math.random() * 40 + 20; // ‡¶Æ‡ßÅ‡¶≠‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡ßÅ‡¶≤‡¶°‡¶æ‡¶â‡¶® ‡¶ï‡¶Æ‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
        }

        // ‡¶≠‡¶ø‡¶≤‡ßá‡¶®‡ßá‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ï
        if (this.attackCooldown-- <= 0 && inAttackRange && !this.isAttacking) {
            const attacks = Object.keys(this.assets.attacks); 
            const attackType = attacks[Math.floor(Math.random() * attacks.length)]; 
            this.performAttack(attackType); 
            this.attackCooldown = Math.random() * 80 + 40; // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ï ‡¶ï‡ßÅ‡¶≤‡¶°‡¶æ‡¶â‡¶® ‡¶ï‡¶Æ‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
        }
    }

    performAttack(type) {
        this.isAttacking = true; 
        this.currentState = type; 
        this.dx = 0; 
        this.direction = hero.x > this.x ? 'right' : 'left'; 
        playSound(`${type.toLowerCase()}-attack-sound`);
        
        let projectileAsset;
        let projectileWidth, projectileHeight;
        let damageAmount = 0; // ‡¶¨‡ßá‡¶∏‡¶ø‡¶ï ‡¶°‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶ú, ‡¶™‡¶∞‡ßá ‡¶ü‡¶æ‡¶á‡¶™ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶∏‡ßá‡¶ü ‡¶π‡¶¨‡ßá

        switch(type) {
            case 'urine': 
                projectileAsset = ASSETS.projectiles.villain_urine; 
                projectileWidth = 60; 
                projectileHeight = 40; 
                damageAmount = 5; // ‡¶á‡¶â‡¶∞‡¶ø‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ï‡ßá‡¶∞ ‡¶°‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶ú ‡¶ï‡¶Æ‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
                break;
            case 'blow': 
                projectileAsset = ASSETS.projectiles.villain_blow; 
                projectileWidth = 70; 
                projectileHeight = 50; 
                damageAmount = 7; // ‡¶¨‡ßç‡¶≤‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ï‡ßá‡¶∞ ‡¶°‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶ú ‡¶ï‡¶Æ‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
                break;
            case 'chada': 
                projectileAsset = ASSETS.projectiles.villain_chada; 
                projectileWidth = 80; 
                projectileHeight = 60; 
                damageAmount = 10; // ‡¶ö‡¶æ‡¶¶‡¶æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ï‡ßá‡¶∞ ‡¶°‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶ú ‡¶ï‡¶Æ‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
                break;
            case 'election': 
                projectileAsset = ASSETS.projectiles.villain_election; 
                projectileWidth = 90; 
                projectileHeight = 70; 
                damageAmount = 12; // ‡¶á‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ï‡ßá‡¶∞ ‡¶°‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶ú ‡¶ï‡¶Æ‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
                break;
            default: 
                projectileAsset = ASSETS.projectiles.villain_urine; 
                projectileWidth = 60; 
                projectileHeight = 40;
                damageAmount = 5;
        }

        setTimeout(() => { 
            if (this.isOut) return; 

            // ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ X ‡¶™‡¶ú‡¶ø‡¶∂‡¶®: ‡¶≠‡¶ø‡¶≤‡ßá‡¶®‡ßá‡¶∞ ‡¶¶‡¶ø‡¶ï ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶π‡¶æ‡¶§ ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡ßá‡¶∞ ‡¶π‡¶¨‡ßá
            let projectileX = this.x;
            if (this.direction === 'right') {
                projectileX = this.x + this.width - 20; // ‡¶°‡¶æ‡¶® ‡¶¶‡¶ø‡¶ï‡ßá ‡¶ó‡ßá‡¶≤‡ßá ‡¶≠‡¶ø‡¶≤‡ßá‡¶®‡ßá‡¶∞ ‡¶°‡¶æ‡¶® ‡¶™‡¶æ‡¶∂ ‡¶•‡ßá‡¶ï‡ßá, ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶≠‡¶ø‡¶§‡¶∞‡ßá‡¶∞ ‡¶¶‡¶ø‡¶ï‡ßá
            } else {
                projectileX = this.x - 20; // ‡¶¨‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶ï‡ßá ‡¶ó‡ßá‡¶≤‡ßá ‡¶≠‡¶ø‡¶≤‡ßá‡¶®‡ßá‡¶∞ ‡¶¨‡¶æ‡¶Æ ‡¶™‡¶æ‡¶∂ ‡¶•‡ßá‡¶ï‡ßá, ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶≠‡¶ø‡¶§‡¶∞‡ßá‡¶∞ ‡¶¶‡¶ø‡¶ï‡ßá
            }

            // ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ Y ‡¶™‡¶ú‡¶ø‡¶∂‡¶®: ‡¶≠‡¶ø‡¶≤‡ßá‡¶®‡ßá‡¶∞ ‡¶¨‡ßÅ‡¶ï‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ù‡¶æ‡¶Æ‡¶æ‡¶ù‡¶ø ‡¶•‡ßá‡¶ï‡ßá (‡¶π‡¶æ‡¶§ ‡¶Ø‡ßá‡¶ñ‡¶æ‡¶®‡ßá ‡¶•‡¶æ‡¶ï‡ßá)
            const projectileY = this.y + this.height * 0.4; // ‡¶Ü‡¶®‡ßÅ‡¶Æ‡¶æ‡¶®‡¶ø‡¶ï ‡¶π‡¶æ‡¶§‡ßá‡¶∞ ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ, ‡¶Ø‡¶æ‡¶§‡ßá ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶¶‡¶ø‡¶ï‡ßá ‡¶•‡¶æ‡¶ï‡ßá

            projectiles.push(new Projectile(
                projectileX, 
                projectileY, 
                this.direction, 
                'villain', 
                damageAmount, 
                projectileAsset, 
                projectileWidth, 
                projectileHeight
            )); 
            this.isAttacking = false; 
        }, 400); // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ï ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶Æ‡ßá‡¶∂‡¶® ‡¶ü‡¶æ‡¶á‡¶Æ‡¶ø‡¶Ç ‡¶ï‡¶Æ‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá
    }
    update() { 
        if (!gameOver) this.ai(); 
        super.update(); 
    }
}

class Projectile {
    constructor(x, y, direction, owner, damage, asset, width, height) { 
        Object.assign(this, {x, y, direction, owner, damage, asset, width, height, speed: 15}); 
        this.img = images[asset]; // ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶á‡¶Æ‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
    }
    update() { 
        this.x += this.direction === 'right' ? this.speed : -this.speed; 
        this.draw(); 
    }
    draw() { 
        // ‡¶Ø‡¶¶‡¶ø ‡¶á‡¶Æ‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá ‡¶á‡¶Æ‡ßá‡¶ú ‡¶Ü‡¶Å‡¶ï‡¶æ ‡¶π‡¶¨‡ßá, ‡¶Ö‡¶®‡ßç‡¶Ø‡¶•‡¶æ‡¶Ø‡¶º ‡¶è‡¶ï‡¶ü‡¶ø ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶Ü‡¶Ø‡¶º‡¶§‡¶ï‡ßç‡¶∑‡ßá‡¶§‡ßç‡¶∞ ‡¶Ü‡¶Å‡¶ï‡¶æ ‡¶π‡¶¨‡ßá‡•§
        if (this.img && this.img.complete) { 
            ctx.drawImage(this.img, this.x, this.y, this.width, this.height); 
        } else { 
            ctx.fillStyle = this.owner === 'hero' ? 'cyan' : 'yellow'; 
            ctx.fillRect(this.x, this.y, this.width, this.height); 
        }
    }
}

class PowerUp {
    constructor(x, y, type) { Object.assign(this, {x, y, width: 50, height: 50, type, asset: ASSETS.powerups[type], dy: 0, gravity: 0.5, onGround: false}); this.img = images[this.asset]; }
    update() { if (!this.onGround) { this.dy += this.gravity; this.y += this.dy; const groundPos = canvas.height - groundHeight - this.height; if (this.y >= groundPos) { this.y = groundPos; this.onGround = true; } } this.draw(); }
    draw() { if(this.img) ctx.drawImage(this.img, this.x, this.y, this.width, this.height); }
}

const birdInfo = { x: -100, y: 100, width: 80, height: 60, speed: 2, timer: 0, interval: 600 };

function init() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    groundHeight = canvas.height / 3.5;
    const heroWidth = 30;
    const heroHeight = 50;
    const villainWidth = 30;
    const villainHeight = 50;
    hero = new Character(100, canvas.height - groundHeight - heroHeight, heroWidth, heroHeight, 100, 5, ASSETS.hero);
    villain = new Villain(canvas.width - villainWidth - 100, canvas.height - groundHeight - villainHeight, villainWidth, villainHeight, 150, 4, ASSETS.villain);
    powerups = []; projectiles = [];
    cooldowns.special.last = -cooldowns.special.time;
    cooldowns.shield.last = -cooldowns.shield.time;
    document.getElementById('hero-avatar').src = ASSETS.hero.idle;
    document.getElementById('villain-avatar').src = ASSETS.villain.idle;
    initBackgroundElements();
    updateHealthBars();
}

function initBackgroundElements() {
    stars = []; 
    // ‡¶§‡¶æ‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶ï‡¶Æ‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‡¶è‡¶¨‡¶Ç ‡¶õ‡ßã‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‡¶™‡¶æ‡¶∞‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
    for (let i = 0; i < 75; i++) { 
        stars.push({ x: Math.random() * canvas.width, y: Math.random() * (canvas.height * 0.6), radius: Math.random() * 1 + 0.5, alpha: Math.random() * 0.5 + 0.5 }); 
    }
    clouds = []; for (let i = 0; i < 10; i++) { clouds.push({ x: Math.random() * canvas.width, y: 50 + Math.random() * 100, width: 150 + Math.random() * 100, height: 80 + Math.random() * 50, speed: 0.1 + Math.random() * 0.2 }); }
}

const keys = { left: false, right: false };
const cooldowns = { special: { time: 10000, last: 0 }, shield: { time: 15000, last: 0 } };

function setupControls() {
    document.getElementById('jump-btn').addEventListener('touchstart', (e) => { e.preventDefault(); hero.jump(); triggerVibration(); });
    document.getElementById('attack-btn').addEventListener('touchstart', (e) => { e.preventDefault(); heroAttack(); triggerVibration(); });
    document.getElementById('special-btn').addEventListener('touchstart', (e) => { e.preventDefault(); heroSpecialAttack(); triggerVibration(50); });
    document.getElementById('shield-btn').addEventListener('touchstart', (e) => { e.preventDefault(); heroShield(); triggerVibration(50); });
    const handlePress = (key, value) => (e) => { e.preventDefault(); keys[key] = value; };
    const leftBtn = document.getElementById('left-btn');
    const rightBtn = document.getElementById('right-btn');
    leftBtn.addEventListener('touchstart', handlePress('left', true), { passive: false });
    leftBtn.addEventListener('touchend', handlePress('left', false), { passive: false });
    rightBtn.addEventListener('touchstart', handlePress('right', true), { passive: false });
    rightBtn.addEventListener('touchend', handlePress('right', false), { passive: false });
    document.getElementById('jump-btn').addEventListener('mousedown', () => { hero.jump(); triggerVibration(); });
    document.getElementById('attack-btn').addEventListener('mousedown', () => { heroAttack(); triggerVibration(); });
    document.getElementById('special-btn').addEventListener('mousedown', () => { heroSpecialAttack(); triggerVibration(50); });
    document.getElementById('shield-btn').addEventListener('mousedown', () => { heroShield(); triggerVibration(50); });
    leftBtn.addEventListener('mousedown', handlePress('left', true));
    leftBtn.addEventListener('mouseup', handlePress('left', false));
    rightBtn.addEventListener('mousedown', handlePress('right', true));
    rightBtn.addEventListener('mouseup', handlePress('right', false));
    window.addEventListener('keydown', e => {
        if (e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') keys.left = true;
        if (e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') keys.right = true;
        if (e.key === ' ' || e.key === 'ArrowUp' || e.key.toLowerCase() === 'w') { hero.jump(); triggerVibration(); }
        if (e.key.toLowerCase() === 'j') { heroAttack(); triggerVibration(); }
        if (e.key.toLowerCase() === 'k') { heroSpecialAttack(); triggerVibration(50); }
        if (e.key.toLowerCase() === 'l') { heroShield(); triggerVibration(50); }
    });
    window.addEventListener('keyup', e => {
        if (e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') keys.left = false;
        if (e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') keys.right = false;
    });
}

function heroAttack() {
    if (hero.isAttacking || hero.isOut) return;
    hero.isAttacking = true; hero.currentState = 'attack'; playSound('attack-sound');
    setTimeout(() => {
        hero.isAttacking = false;
        const attackHitbox = { x: hero.direction === 'right' ? hero.x : hero.x - hero.width, y: hero.y, width: hero.width * 1.5, height: hero.height };
        if (attackHitbox.x < villain.x + villain.width && attackHitbox.x + attackHitbox.width > villain.x && attackHitbox.y < villain.y + villain.height && attackHitbox.height + attackHitbox.y > villain.y) {
            // ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶Ø‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶∏‡¶æ‡¶Æ‡¶®‡ßá ‡¶•‡¶æ‡¶ï‡¶æ ‡¶∂‡¶§‡ßç‡¶∞‡ßÅ‡¶ï‡ßá ‡¶Ü‡¶ò‡¶æ‡¶§ ‡¶ï‡¶∞‡¶¨‡ßá
            if ((hero.direction === 'right' && villain.x > hero.x) || (hero.direction === 'left' && villain.x < hero.x)) { 
                villain.takeDamage(5); // ‡¶¨‡ßá‡¶∏‡¶ø‡¶ï ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ï‡ßá‡¶∞ ‡¶°‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶ú ‡¶ï‡¶Æ‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
            }
        }
    }, 400);
}

function startCooldown(button, duration) {
    button.classList.add('cooldown'); let secondsLeft = Math.ceil(duration / 1000);
    const update = () => button.setAttribute('data-cooldown', secondsLeft); update();
    const interval = setInterval(() => { secondsLeft--; if (secondsLeft > 0) update(); else { clearInterval(interval); button.classList.remove('cooldown'); button.removeAttribute('data-cooldown'); } }, 1000);
}

function heroSpecialAttack() {
    const now = Date.now(); if (now - cooldowns.special.last < cooldowns.special.time || hero.isOut) return;
    cooldowns.special.last = now; startCooldown(document.getElementById('special-btn'), cooldowns.special.time);
    hero.isAttacking = true; hero.currentState = 'special'; playSound('powerup-sound'); triggerVibration(75);
    setTimeout(() => { 
        if(hero.isOut) return; 
        const projectileWidth = 80; 
        const projectileHeight = 50; 

        // ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ X ‡¶™‡¶ú‡¶ø‡¶∂‡¶®: ‡¶π‡¶ø‡¶∞‡ßã‡¶∞ ‡¶¶‡¶ø‡¶ï ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶π‡¶æ‡¶§ ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡ßá‡¶∞ ‡¶π‡¶¨‡ßá
        let projectileX = hero.x;
        if (hero.direction === 'right') {
            projectileX = hero.x + hero.width - 20; // ‡¶°‡¶æ‡¶® ‡¶¶‡¶ø‡¶ï‡ßá ‡¶ó‡ßá‡¶≤‡ßá ‡¶π‡¶ø‡¶∞‡ßã‡¶∞ ‡¶°‡¶æ‡¶® ‡¶™‡¶æ‡¶∂ ‡¶•‡ßá‡¶ï‡ßá, ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶≠‡¶ø‡¶§‡¶∞‡ßá‡¶∞ ‡¶¶‡¶ø‡¶ï‡ßá
        } else {
            projectileX = hero.x - 20; // ‡¶¨‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶ï‡ßá ‡¶ó‡ßá‡¶≤‡ßá ‡¶π‡¶ø‡¶∞‡ßã‡¶∞ ‡¶¨‡¶æ‡¶Æ ‡¶™‡¶æ‡¶∂ ‡¶•‡ßá‡¶ï‡ßá, ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶≠‡¶ø‡¶§‡¶∞‡ßá‡¶∞ ‡¶¶‡¶ø‡¶ï‡ßá
        }

        // ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ Y ‡¶™‡¶ú‡¶ø‡¶∂‡¶®: ‡¶π‡¶ø‡¶∞‡ßã‡¶∞ ‡¶¨‡ßÅ‡¶ï‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ù‡¶æ‡¶Æ‡¶æ‡¶ù‡¶ø ‡¶•‡ßá‡¶ï‡ßá (‡¶π‡¶æ‡¶§ ‡¶Ø‡ßá‡¶ñ‡¶æ‡¶®‡ßá ‡¶•‡¶æ‡¶ï‡ßá)
        const projectileY = hero.y + hero.height * 0.4; // ‡¶Ü‡¶®‡ßÅ‡¶Æ‡¶æ‡¶®‡¶ø‡¶ï ‡¶π‡¶æ‡¶§‡ßá‡¶∞ ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ, ‡¶Ø‡¶æ‡¶§‡ßá ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶¶‡¶ø‡¶ï‡ßá ‡¶•‡¶æ‡¶ï‡ßá

        projectiles.push(new Projectile(
            projectileX, 
            projectileY, 
            hero.direction, 
            'hero', 
            15, // ‡¶∏‡ßç‡¶™‡ßá‡¶∂‡¶æ‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ï‡ßá‡¶∞ ‡¶°‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶ú ‡¶ï‡¶Æ‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
            ASSETS.projectiles.hero_special, 
            projectileWidth, 
            projectileHeight
        )); 
        hero.isAttacking = false; 
    }, 500);
}

function heroShield() {
    const now = Date.now(); if (now - cooldowns.shield.last < cooldowns.shield.time || hero.isOut) return;
    cooldowns.shield.last = now; startCooldown(document.getElementById('shield-btn'), cooldowns.shield.time);
    hero.isShielded = true; playSound('shield-sound'); triggerVibration(75);
    setTimeout(() => hero.isShielded = false, 5000);
}

function handlePlayerMovement() {
    hero.dx = 0;
    if (keys.left) { hero.dx = -hero.speed; hero.direction = 'left'; }
    if (keys.right) { hero.dx = hero.speed; hero.direction = 'right'; }
}

let groundHeight = 100;

function drawBackground() {
    dayNightCycle += timeTransitionSpeed; 
    if (dayNightCycle >= Math.PI * 2) dayNightCycle = 0;
    
    // ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶Ü‡¶≤‡ßã: 0 (‡¶∞‡¶æ‡¶§) ‡¶•‡ßá‡¶ï‡ßá 1 (‡¶¶‡¶ø‡¶®) ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§
    const lightness = Math.max(0, Math.sin(dayNightCycle)); // ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶¨‡ßá‡¶≤‡¶æ‡ßü 0 ‡¶•‡ßá‡¶ï‡ßá 1, ‡¶∞‡¶æ‡¶§‡ßá‡¶∞ ‡¶¨‡ßá‡¶≤‡¶æ‡ßü 0

    // ‡¶Ü‡¶ï‡¶æ‡¶∂‡ßá‡¶∞ ‡¶∞‡¶Ç ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®: ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶¨‡ßá‡¶≤‡¶æ‡ßü ‡¶π‡¶æ‡¶≤‡¶ï‡¶æ ‡¶®‡ßÄ‡¶≤, ‡¶∞‡¶æ‡¶§‡ßá‡¶∞ ‡¶¨‡ßá‡¶≤‡¶æ‡ßü ‡¶ó‡¶æ‡¶¢‡¶º ‡¶®‡ßÄ‡¶≤/‡¶¨‡ßá‡¶ó‡ßÅ‡¶®‡¶ø
    const r = Math.floor(135 + 120 * lightness); 
    const g = Math.floor(206 + 50 * lightness);  
    const b = Math.floor(235 - 50 * lightness);  
    
    ctx.fillStyle = `rgb(${r},${g},${b})`;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // ‡¶§‡¶æ‡¶∞‡¶æ‡¶∞ ‡¶∏‡ßç‡¶¨‡¶ö‡ßç‡¶õ‡¶§‡¶æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®: ‡¶∞‡¶æ‡¶§‡ßá‡¶∞ ‡¶¨‡ßá‡¶≤‡¶æ‡ßü 0 ‡¶•‡ßá‡¶ï‡ßá 1 ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶Æ‡¶∏‡ßÉ‡¶£ ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡¶ø‡¶∂‡¶®
    const nightProgress = Math.max(0, Math.min(1, (Math.cos(dayNightCycle - Math.PI) + 1) / 2));
    drawStars(nightProgress); 

    drawSunAndMoon();
    
    drawBird(); 
    drawClouds();

    drawLayer(parallaxOffset, 0.1, () => {
        const houseImg = images[ASSETS.environment.house];
        if (houseImg) ctx.drawImage(houseImg, 0, canvas.height - groundHeight - 160, canvas.width, 150);
    });

    // ‡¶Æ‡¶æ‡¶ü‡¶ø‡¶∞ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶≤‡¶ø‡¶Ç ‡¶ó‡¶§‡¶ø ‡¶ï‡¶Æ‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá
    drawLayer(parallaxOffset, 0.2, () => {
        const groundImg = images[ASSETS.environment.ground];
        if (groundImg) ctx.drawImage(groundImg, 0, canvas.height - groundHeight - 20, canvas.width, groundHeight + 20);
    });
}

function drawStars(nightProgress) {
    ctx.save();
    stars.forEach(star => { 
        ctx.beginPath(); ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2); 
        ctx.globalAlpha = star.alpha * nightProgress; 
        ctx.fillStyle = 'white'; 
        ctx.fill(); 
    });
    ctx.restore();
}

function drawSunAndMoon() {
    const sunImg = images[ASSETS.environment.sun];
    const moonImg = images[ASSETS.environment.moon];
    const celestialWidth = 120, celestialHeight = 120;
    const travelRadius = Math.min(canvas.width, canvas.height) / 2 * 0.8; // ‡¶≠‡ßç‡¶∞‡¶Æ‡¶£ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶∏‡¶æ‡¶∞‡ßç‡¶ß
    const centerX = canvas.width / 2;
    const centerY = canvas.height * 0.4; // ‡¶Ü‡¶ï‡¶æ‡¶∂ ‡¶¨‡¶∞‡¶æ‡¶¨‡¶∞ ‡¶Æ‡¶æ‡¶ù‡¶ñ‡¶æ‡¶®‡ßá ‡¶∞‡¶æ‡¶ñ‡¶æ

    // ‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø‡ßá‡¶∞ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®
    const sunAngle = dayNightCycle - Math.PI / 2; // ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶§‡ßá ‡¶â‡¶™‡¶∞‡ßá
    const sunX = centerX + travelRadius * Math.cos(sunAngle) - celestialWidth / 2;
    const sunY = centerY + travelRadius * Math.sin(sunAngle) - celestialHeight / 2;

    // ‡¶ö‡¶æ‡¶Å‡¶¶‡ßá‡¶∞ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® (‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø‡ßá‡¶∞ ‡¶•‡ßá‡¶ï‡ßá 180 ‡¶°‡¶ø‡¶ó‡ßç‡¶∞‡¶ø ‡¶¶‡ßÇ‡¶∞‡ßá)
    const moonAngle = dayNightCycle + Math.PI / 2; // ‡¶∞‡¶æ‡¶§‡ßá‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶§‡ßá ‡¶â‡¶™‡¶∞‡ßá
    const moonX = centerX + travelRadius * Math.cos(moonAngle) - celestialWidth / 2;
    const moonY = centerY + travelRadius * Math.sin(moonAngle) - celestialHeight / 2;

    // ‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø ‡¶∏‡¶¨‡¶∏‡¶Æ‡ßü ‡¶â‡¶ú‡ßç‡¶ú‡ßç‡¶¨‡¶≤ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
    ctx.globalAlpha = 1; 
    if (sunImg) ctx.drawImage(sunImg, sunX, sunY, celestialWidth, celestialHeight);

    // ‡¶ö‡¶æ‡¶Å‡¶¶ ‡¶∏‡¶¨‡¶∏‡¶Æ‡ßü ‡¶â‡¶ú‡ßç‡¶ú‡ßç‡¶¨‡¶≤ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
    ctx.globalAlpha = 1; 
    if (moonImg) ctx.drawImage(moonImg, moonX, moonY, celestialWidth, celestialHeight);
}

// ‡¶™‡¶æ‡¶ñ‡¶ø‡¶∞ ‡¶Ü‡¶ó‡¶Æ‡¶® ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡ßá‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
function drawBird() {
    // ‡¶™‡¶æ‡¶ñ‡¶ø ‡¶Ø‡¶¶‡¶ø ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡ßá ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá ‡¶§‡¶æ‡¶ï‡ßá ‡¶∏‡¶ö‡¶≤ ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡¶¨‡ßá
    if (birdInfo.x > -birdInfo.width) {
        birdInfo.x -= birdInfo.speed;
    }

    // ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶¨‡¶æ‡ßú‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá
    birdInfo.timer++;
    // ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶∏‡¶Æ‡ßü ‡¶™‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶ñ‡¶ø ‡¶Ü‡¶®‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá
    if (birdInfo.timer > birdInfo.interval) {
        birdInfo.timer = 0; // ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
        // ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶™‡¶æ‡¶ñ‡¶ø ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡ßá‡¶∞ ‡¶¨‡¶æ‡¶á‡¶∞‡ßá ‡¶ö‡¶≤‡ßá ‡¶ó‡¶ø‡ßü‡ßá ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá‡¶á ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶ñ‡¶ø ‡¶Ü‡¶∏‡¶¨‡ßá
        if (birdInfo.x <= -birdInfo.width) {
            birdInfo.x = canvas.width; // ‡¶°‡¶æ‡¶® ‡¶¶‡¶ø‡¶ï ‡¶•‡ßá‡¶ï‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶¨‡ßá
            birdInfo.y = 50 + Math.random() * 150;
            playSound('bird-dialogue-sound');
        }
    }

    // ‡¶™‡¶æ‡¶ñ‡¶ø ‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßç‡¶Ø‡¶æ‡¶®‡¶≠‡¶æ‡¶∏‡ßá‡¶∞ ‡¶¶‡ßÉ‡¶∂‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶Ö‡¶Ç‡¶∂‡ßá ‡¶•‡¶æ‡¶ï‡ßá ‡¶§‡¶¨‡ßá‡¶á ‡¶Ü‡¶Å‡¶ï‡¶æ ‡¶π‡¶¨‡ßá
    const birdImg = images[ASSETS.environment.bird];
    if (birdImg && birdInfo.x < canvas.width && birdInfo.x > -birdInfo.width) {
        ctx.drawImage(birdImg, birdInfo.x, birdInfo.y, birdInfo.width, birdInfo.height);
    }
}

function drawClouds() {
    const cloudImg = images[ASSETS.environment.cloud];
    if (cloudImg) { clouds.forEach(cloud => { cloud.x += cloud.speed; if (cloud.x > canvas.width) { cloud.x = -cloud.width; } ctx.drawImage(cloudImg, cloud.x, cloud.y, cloud.width, cloud.height); }); }
}

function drawLayer(offset, speed, drawCallback) {
    const layerOffset = (offset * speed) % canvas.width;
    ctx.save(); ctx.translate(-layerOffset, 0); drawCallback();
    ctx.translate(canvas.width, 0); drawCallback();
    ctx.restore();
}

function updateHealthBars() {
    // ‡¶∏‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶•‡ßç‡¶Ø ‡¶Ø‡¶¶‡¶ø ‡ß¶ ‡¶π‡¶Ø‡¶º, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶â‡¶á‡¶°‡¶• ‡ß¶% ‡¶π‡¶¨‡ßá‡•§
    document.getElementById('hero-health-inner').style.width = `${(hero.health / hero.maxHealth) * 100}%`;
    document.getElementById('villain-health-inner').style.width = `${(villain.health / villain.maxHealth) * 100}%`;
}

let powerupTimer = 0;
const powerupInterval = 1800;
function handlePowerups() {
    if (++powerupTimer > powerupInterval) { powerupTimer = 0; powerups.push(new PowerUp(Math.random()*(canvas.width-50), -50, 'health')); }
    powerups.forEach((p, i) => {
        p.update();
        // Corrected collision detection for power-ups
        if (hero.x < p.x + p.width && 
            hero.x + hero.width > p.x && // Corrected this line
            hero.y < p.y + p.height && 
            hero.y + hero.height > p.y) {
            
            if (p.type === 'health') hero.health = Math.min(hero.maxHealth, hero.health + 20);
            playSound('powerup-sound'); triggerVibration([50, 50, 50]);
            powerups.splice(i, 1); updateHealthBars();
        }
    });
}

function handleCollisions() {
    projectiles.forEach((p, pIndex) => {
        let target = p.owner === 'hero' ? villain : hero;
        
        // ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶∏‡¶Ç‡¶ò‡¶∞‡ßç‡¶∑ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ
        // ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü‡ßá‡¶∞ bounding boxs ‡¶è‡¶∞ ‡¶ì‡¶≠‡¶æ‡¶∞‡¶≤‡ßç‡¶Ø‡¶æ‡¶™ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
        if (p.x < target.x + target.width && 
            p.x + p.width > target.x && 
            p.y < target.y + target.height && 
            p.y + p.height > target.y) {
            
            target.takeDamage(p.damage); // ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶°‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶ú ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
            projectiles.splice(pIndex, 1); // ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶∏‡¶∞‡¶ø‡¶Ø‡¶º‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
        }
        // ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡ßá‡¶∞ ‡¶¨‡¶æ‡¶á‡¶∞‡ßá ‡¶ö‡¶≤‡ßá ‡¶ó‡ßá‡¶≤‡ßá ‡¶§‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá
        else if (p.x > canvas.width || p.x + p.width < 0) {
            projectiles.splice(pIndex, 1);
        }
    });
}

function triggerGameOver(message) {
    if (gameOver) return; 
    gameOver = true; 
    playSound('game-over-sound');

    const msgEl = document.getElementById('game-over-message');
    msgEl.textContent = message;
    if (message.includes('‡¶π‡¶ø‡¶∞‡ßã')) { 
        msgEl.className = 'win-message'; 
    } else { 
        msgEl.className = 'lose-message'; 
    }
    msgEl.style.display = 'block';

    // ‡¶∞‡¶ø‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü ‡¶≤‡¶ú‡¶ø‡¶ï
    setTimeout(() => {
        const lastRedirectDate = localStorage.getItem('lastRedirectDate');
        const today = new Date().toDateString();

        if (lastRedirectDate !== today) {
            // ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¶‡¶ø‡¶®‡ßá ‡¶è‡¶ñ‡¶®‡¶ì ‡¶∞‡¶ø‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü ‡¶®‡¶æ ‡¶π‡ßü‡ßá ‡¶•‡¶æ‡¶ï‡ßá
            localStorage.setItem('lastRedirectDate', today);
            window.location.href = redirectUrl;
        } else {
            // ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¶‡¶ø‡¶®‡ßá ‡¶è‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡ßü‡ßá ‡¶•‡¶æ‡¶ï‡¶≤‡ßá, ‡¶Ü‡¶∞ ‡¶π‡¶¨‡ßá ‡¶®‡¶æ
            console.log("Already redirected today. Skipping redirection.");
        }
    }, 2000); // 2 ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞ ‡¶∞‡¶ø‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶¨‡ßá
}

function playSound(id) {
    const sound = document.getElementById(id);
    if(sound && sound.src && sound.src.includes('http')) {
        sound.currentTime = 0;
        sound.play().catch(e => { /* console.log(`Could not play sound: ${id}`, e); */ });
    }
}

function gameLoop() {
    if (!gameRunning) return;
    if (!gameOver) {
        requestAnimationFrame(gameLoop);
        parallaxOffset = hero.x;
        ctx.clearRect(0, 0, canvas.width, canvas.height); // ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶´‡ßç‡¶∞‡ßá‡¶Æ‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶®‡¶≠‡¶æ‡¶∏ ‡¶™‡¶∞‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ

        drawBackground(); // ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶Ü‡¶Å‡¶ï‡¶æ (‡¶Ü‡¶ï‡¶æ‡¶∂‡ßá‡¶∞ ‡¶∞‡¶Ç, ‡¶§‡¶æ‡¶∞‡¶æ, ‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø/‡¶ö‡¶æ‡¶Å‡¶¶, ‡¶™‡¶æ‡¶ñ‡¶ø, ‡¶Æ‡ßá‡¶ò)
        
        // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∞‡ßá‡¶ï‡ßç‡¶ü‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶ó‡¶§‡¶ø‡¶∂‡ßÄ‡¶≤ ‡¶â‡¶™‡¶æ‡¶¶‡¶æ‡¶® ‡¶Ü‡¶Å‡¶ï‡¶æ
        handlePlayerMovement();
        hero.update();
        villain.update();
        projectiles.forEach(p => p.update());
        handlePowerups();
        handleCollisions();
    }
}

function startGame() {
    document.getElementById('start-screen').style.opacity = '0';
    setTimeout(() => {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        init(); gameRunning = true; gameOver = false;
        const bgMusic = document.getElementById('bg-music');
        bgMusic.volume = 0.2; bgMusic.play().catch(e => {});
        gameLoop();
    }, 500);
}

window.addEventListener('resize', () => { if (gameRunning) init(); });

window.onload = () => {
    loadAssets(() => {
        const loadingScreen = document.getElementById('loading-screen');
        loadingScreen.style.opacity = '0';
        setTimeout(() => { loadingScreen.style.display = 'none'; document.getElementById('start-screen').style.display = 'flex'; }, 500);
        document.getElementById('start-button').addEventListener('click', startGame);
        setupControls();
    });
};

</script>
</body>
</html>